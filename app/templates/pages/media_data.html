{% extends "base.html" %}
{% from "components/file_item.html" import file_item %}

{% block title %}Media Data - MediaLab Manager{% endblock %}

{% block header_title %}Media Data{% endblock %}

{% block content %}
<div class="media-data">
    <!-- Filter Panel -->
    <div class="filter-panel">
        <div class="filter-controls">
            <div class="filter-group">
                <label for="media-type">Media Type</label>
                <select id="media-type" onchange="applyFilters()">
                    <option value="">All Types</option>
                    <option value="tv">TV Shows</option>
                    <option value="movie">Movies</option>
                </select>
            </div>
            <div class="filter-group search-group">
                <label for="search">Search</label>
                <div class="search-input-group">
                    <input type="text" id="search" placeholder="Search titles..." oninput="applyFilters()">
                    <button class="icon-button" onclick="collapseAll()" title="Collapse All">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                            <polyline points="2 17 12 22 22 17"></polyline>
                            <polyline points="2 12 12 17 22 12"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Items List -->
    <div class="media-items">
        <!-- TV Show Item -->
        <div class="media-item" data-type="tv">
            <div class="media-item-header" onclick="toggleDetails(this)">
                <div class="media-item-title">
                    <span class="media-icon">ðŸ“º</span>
                    Breaking Bad
                </div>
                <div class="media-item-meta">
                    <span>TV Show</span>
                    <span>5 Seasons</span>
                    <span>Added: 2023-07-15</span>
                    <button class="expand-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="media-item-details">
                <!-- Season 1 -->
                <div class="season-group">
                    <div class="season-header" onclick="toggleSeason(this)">
                        <h4>Season 1</h4>
                        <span class="episode-count">3 Episodes</span>
                        <button class="expand-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="season-content">
                        <div class="file-list">
                            {{ file_item("Breaking Bad S01E01 - Pilot.mkv", "Pilot", "E01", [
                            {"quality": "4K", "in_cache": true, "pending": true},
                            {"quality": "1080p", "in_cache": false}
                            ]) }}
                            {{ file_item("Breaking Bad S01E02 - Cat's in the Bag.mkv", "Cat's in the Bag", "E02", [
                            {"quality": "1080p", "in_cache": true, "pending": true}
                            ]) }}
                            {{ file_item("Breaking Bad S01E03 - And the Bag's in the River.mkv", "And the Bag's in the
                            River", "E03", [
                            {"quality": "4K", "in_cache": true},
                            {"quality": "1080p", "in_cache": true, "pending": true}
                            ]) }}
                        </div>
                    </div>
                </div>
                <!-- Season 2 -->
                <div class="season-group">
                    <div class="season-header" onclick="toggleSeason(this)">
                        <h4>Season 2</h4>
                        <span class="episode-count">2 Episodes</span>
                        <button class="expand-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="season-content">
                        <div class="file-list">
                            {{ file_item("Breaking Bad S02E01 - 737.mkv", "737", "E01", [
                            {"quality": "1080p", "in_cache": true}
                            ]) }}
                            {{ file_item("Breaking Bad S02E02 - Grilled.mkv", "Grilled", "E02", [
                            {"quality": "4K", "in_cache": false},
                            {"quality": "1080p", "in_cache": true}
                            ]) }}
                        </div>
                    </div>
                </div>
                <!-- Misc Files Section -->
                <div class="season-group">
                    <div class="season-header" onclick="toggleSeason(this)">
                        <h4>Misc Files</h4>
                        <span class="episode-count">Associated Files</span>
                        <button class="expand-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="season-content">
                        <div class="file-list">
                            {{ file_item("Breaking Bad - Behind the Scenes.mkv", "Behind the Scenes", "", [
                            {"quality": "1080p", "in_cache": false}
                            ], "ðŸ“‹") }}
                            {{ file_item("Breaking Bad - Interviews.mkv", "Cast Interviews", "", [
                            {"quality": "1080p", "in_cache": true}
                            ], "ðŸ“‹") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movie Item -->
        <div class="media-item" data-type="movie">
            <div class="media-item-header" onclick="toggleDetails(this)">
                <div class="media-item-title">
                    <span class="media-icon">ðŸŽ¬</span>
                    Inception
                </div>
                <div class="media-item-meta">
                    <span>Movie</span>
                    <span>2010</span>
                    <span>Added: 2023-08-20</span>
                    <button class="expand-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="media-item-details">
                <div class="file-list">
                    {{ file_item("Inception (2010).mkv", "Inception", "", [
                    {"quality": "4K", "in_cache": true, "pending": true},
                    {"quality": "1080p", "in_cache": true}
                    ], "ðŸŽ¬") }}
                    {{ file_item("Inception (2010) - Special Features.mkv", "Special Features", "", [
                    {"quality": "1080p", "in_cache": false, "pending": true}
                    ], "ðŸŽ¬") }}
                </div>
                <!-- Misc Files Section -->
                <div class="season-group">
                    <div class="season-header" onclick="toggleSeason(this)">
                        <h4>Misc Files</h4>
                        <span class="episode-count">Associated Files</span>
                        <button class="expand-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="season-content">
                        <div class="file-list">
                            {{ file_item("Inception - Behind the Scenes.mkv", "Behind the Scenes", "", [
                            {"quality": "1080p", "in_cache": false}
                            ], "ðŸ“‹") }}
                            {{ file_item("Inception - Making of Documentary.mkv", "Making of Documentary", "", [
                            {"quality": "1080p", "in_cache": true}
                            ], "ðŸ“‹") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TV Show Item -->
        <div class="media-item" data-type="tv">
            <div class="media-item-header" onclick="toggleDetails(this)">
                <div class="media-item-title">
                    <span class="media-icon">ðŸ“º</span>
                    The Mandalorian
                </div>
                <div class="media-item-meta">
                    <span>TV Show</span>
                    <span>3 Seasons</span>
                    <span>Added: 2023-09-05</span>
                    <button class="expand-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="media-item-details">
                <!-- Season 1 -->
                <div class="season-group">
                    <div class="season-header" onclick="toggleSeason(this)">
                        <h4>Season 1</h4>
                        <span class="episode-count">2 Episodes</span>
                        <button class="expand-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="season-content">
                        <div class="file-list">
                            {{ file_item("The Mandalorian S01E01 - Chapter 1.mkv", "Chapter 1", "E01", [
                            {"quality": "4K", "in_cache": true, "pending": true},
                            {"quality": "1080p", "in_cache": true}
                            ]) }}
                            {{ file_item("The Mandalorian S01E02 - Chapter 2.mkv", "Chapter 2", "E02", [
                            {"quality": "4K", "in_cache": false, "pending": true}
                            ]) }}
                        </div>
                    </div>
                </div>
                <!-- Season 2 -->
                <div class="season-group">
                    <div class="season-header" onclick="toggleSeason(this)">
                        <h4>Season 2</h4>
                        <span class="episode-count">2 Episodes</span>
                        <button class="expand-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="season-content">
                        <div class="file-list">
                            {{ file_item("The Mandalorian S02E01 - Chapter 9.mkv", "Chapter 9", "E01", [
                            {"quality": "4K", "in_cache": true}
                            ]) }}
                            {{ file_item("The Mandalorian S02E02 - Chapter 10.mkv", "Chapter 10", "E02", [
                            {"quality": "4K", "in_cache": true},
                            {"quality": "1080p", "in_cache": false}
                            ]) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleDetails(header) {
        const details = header.nextElementSibling;
        const button = header.querySelector('.expand-button');

        details.classList.toggle('active');
        button.classList.toggle('active');
    }

    function toggleSeason(header) {
        const content = header.nextElementSibling;
        const button = header.querySelector('.expand-button');

        content.classList.toggle('active');
        button.classList.toggle('active');
    }

    function collapseAll() {
        // Collapse all media items
        document.querySelectorAll('.media-item-details').forEach(details => {
            details.classList.remove('active');
        });
        document.querySelectorAll('.media-item-header .expand-button').forEach(button => {
            button.classList.remove('active');
        });

        // Collapse all seasons
        document.querySelectorAll('.season-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.season-header .expand-button').forEach(button => {
            button.classList.remove('active');
        });
    }

    function applyFilters() {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const mediaType = document.getElementById('media-type').value;
        const mediaItems = document.querySelectorAll('.media-item');

        mediaItems.forEach(item => {
            const title = item.querySelector('.media-item-title').textContent.toLowerCase();
            const type = item.getAttribute('data-type');

            const matchesSearch = title.includes(searchTerm);
            const matchesType = !mediaType || type === mediaType;

            item.style.display = matchesSearch && matchesType ? 'block' : 'none';
        });
    }

    function toggleCache(button) {
        // Find the quality badge by looking for the button that triggered the click
        const targetBadge = button.closest('.quality-badge');

        if (!targetBadge) {
            console.error('Target badge not found');
            return;
        }

        // Add pending state
        targetBadge.classList.add('pending');
        let pendingBadge = targetBadge.querySelector('.pending-badge');
        if (!pendingBadge) {
            pendingBadge = document.createElement('span');
            pendingBadge.className = 'pending-badge';
            pendingBadge.textContent = 'Pending';
            targetBadge.appendChild(pendingBadge);
        }

        // Simulate API call (replace with actual API call)
        setTimeout(() => {
            // Remove pending state
            targetBadge.classList.remove('pending');
            if (pendingBadge) {
                pendingBadge.remove();
            }

            // Toggle cache state
            targetBadge.classList.toggle('in-cache');

            // Update cache badge
            let cacheBadge = targetBadge.querySelector('.cache-badge');
            if (targetBadge.classList.contains('in-cache')) {
                if (!cacheBadge) {
                    cacheBadge = document.createElement('span');
                    cacheBadge.className = 'cache-badge';
                    cacheBadge.textContent = 'Cache';
                    targetBadge.appendChild(cacheBadge);
                }
            } else if (cacheBadge) {
                cacheBadge.remove();
            }

            // Update action button icon
            const actionButton = targetBadge.querySelector('.cache-action');
            if (actionButton) {
                actionButton.innerHTML = targetBadge.classList.contains('in-cache')
                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>';
            }
        }, 1000); // Simulate 1 second delay
    }
</script>
{% endblock %}